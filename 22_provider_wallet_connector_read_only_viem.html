<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <h1 id="header">Connect to Metamask (Viem)</h1>
    <button class="connect"> Connect</button>
    <button class="disconnect"> Disconnect</button>
    <h2>钱包地址: <span class="showAccount"></span></h2>
    <h2>ChainID: <span class="showChainID"></span></h2>
    <h2>ETH 余额: <span class="showETHBalance"></span></h2>

    <script type="module">
      import { createPublicClient, createWalletClient, custom } from "https://cdn.jsdelivr.net/npm/viem@2.33.1/+esm";
      import { mainnet } from "https://cdn.jsdelivr.net/npm/viem@2.33.1/chains/+esm";
      
      const ethereumButton = document.querySelector('.connect');
      const disconnectButton = document.querySelector('.disconnect');
      const showAccount = document.querySelector('.showAccount');
      const showChainID = document.querySelector('.showChainID');
      const showETHBalance = document.querySelector('.showETHBalance');

      ethereumButton.addEventListener(`click`, onClickHandler)
      disconnectButton.addEventListener(`click`, onDisconnectHandler)
      
      async function onClickHandler() {
          console.log("连接钱包")
          
          if (!window.ethereum) {
              alert('请先安装MetaMask插件！');
              return;
          }
          
          try {
              // 创建 viem 客户端
              const publicClient = createPublicClient({
                  chain: mainnet,
                  transport: custom(window.ethereum)
              });
              
              const walletClient = createWalletClient({
                  chain: mainnet,
                  transport: custom(window.ethereum)
              });
              
              // 请求用户授权并获取钱包地址
              const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
              const account = accounts[0];
              console.log(`钱包地址: ${account}`)
              showAccount.innerHTML = account;
              
              // 读取chainid
              const chainId = await publicClient.getChainId();
              console.log(`chainid: ${chainId}`)
              showChainID.innerHTML = chainId.toString();
              
              // 读取ETH余额
              const balance = await publicClient.getBalance({ address: account });
              console.log(`以太坊余额： ${Number(balance) / 10**18}`)
              showETHBalance.innerHTML = (Number(balance) / 10**18).toString();
              
          } catch (error) {
              console.error('连接失败:', error);
              alert('连接失败: ' + error.message);
          }
        }

      async function onDisconnectHandler() {
          console.log("断开钱包连接")
          // 清空显示的信息
          showAccount.innerHTML = "未连接";
          showChainID.innerHTML = "未连接";
          showETHBalance.innerHTML = "未连接";
          
          // 尝试断开连接（如果钱包支持）
          if (window.ethereum && window.ethereum.removeAllListeners) {
              window.ethereum.removeAllListeners();
          }
          
          console.log("钱包已断开连接")
      }
    </script>  
  </body>
</html> 